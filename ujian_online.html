<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Praktik Flutter Profesional</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo modern */
            --primary-hover: #4338ca;
            --bg-dark: #111827;
            --bg-sidebar: #1f2937;
            --text-light: #f3f4f6;
            --text-gray: #9ca3af;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; height: 100vh; overflow: hidden; background: var(--bg-dark); }

        /* --- ANIMASI --- */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }

        /* --- OVERLAY LOGIN MODERN --- */
        #overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            /* Latar belakang gradien animasi */
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: 99; display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        .login-card { 
            /* Efek Glassmorphism */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; padding: 40px; 
            border-radius: 20px; width: 350px; text-align: center; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .login-card h2 { font-weight: 700; letter-spacing: 1px; margin-bottom: 20px; }

        .status-box {
            background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 10px;
            margin-bottom: 25px; font-size: 0.9em; border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }
        .status-box strong { color: var(--text-light); }

        input.login-input { 
            width: 100%; padding: 15px; margin: 10px 0 20px 0; 
            border: 2px solid rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.05);
            border-radius: 10px; color: white; font-size: 16px;
            transition: 0.3s;
            text-align: center; font-weight: 600; letter-spacing: 2px;
        }
        input.login-input:focus { outline: none; border-color: var(--primary-color); background: rgba(255,255,255,0.1); }
        input.login-input::placeholder { color: rgba(255,255,255,0.5); font-weight: 400; letter-spacing: 0; }
        
        .btn-grad { 
            width: 100%; padding: 15px; 
            background-image: linear-gradient(to right, var(--primary-color) 0%, #3b82f6 51%, var(--primary-color) 100%);
            background-size: 200% auto;
            color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 16px;
            transition: 0.5s; 
        }
        .btn-grad:hover { background-position: right center; transform: translateY(-2px); box-shadow: 0 10px 20px -10px rgba(79, 70, 229, 0.5);}
        .btn-grad:disabled { background: #4b5563; cursor: not-allowed; transform: none; box-shadow: none; color: #9ca3af; }
        
        /* --- APLIKASI UTAMA (TEMA GELAP) --- */
        .app-container { display: flex; width: 100%; height: 100%; background: var(--bg-dark); }
        .sidebar { 
            width: 38%; background: var(--bg-sidebar); color: var(--text-light);
            border-right: 1px solid rgba(255,255,255,0.05); 
            padding: 25px; display: flex; flex-direction: column; 
            box-shadow: 5px 0 15px rgba(0,0,0,0.2); z-index: 10;
        }
        
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .student-info { font-size: 0.9em; color: var(--text-gray); }
        .student-info strong { color: var(--text-light); display: block; font-size: 1.1em; }
        
        .timer-display { 
            font-size: 28px; font-family: 'Courier New', monospace; font-weight: 700; 
            color: var(--text-light); background: rgba(0,0,0,0.3);
            padding: 10px 15px; border-radius: 8px; border: 1px solid var(--danger);
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* Detail Soal Profesional */
        .soal-container { flex: 1; overflow-y: auto; padding-right: 10px; }
        .soal-title { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; color: var(--primary-color); }
        .soal-box { 
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; 
            border-left: 4px solid var(--primary-color); font-size: 0.95em; line-height: 1.6; color: #d1d5db;
        }
        .soal-box h4 { color: var(--text-light); margin-bottom: 10px; }
        .soal-box ul { padding-left: 20px; margin-bottom: 15px; }
        .soal-box li { margin-bottom: 8px; }
        /* Highlight kode dalam soal */
        code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; color: #f472b6; font-family: monospace; font-size: 0.9em;}

        .submission-area { margin-top: 20px; }
        textarea#code { 
            width: 100%; height: 120px; padding: 15px; 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-light); font-family: monospace; border-radius: 10px;
            resize: vertical; margin-bottom: 15px;
        }
        textarea#code:focus { outline: none; border-color: var(--primary-color); }

        .main-panel { flex: 1; background: #000; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="login-card animate-fade-in-up">
            <h2>üöÄ Ujian Flutter Pro</h2>
            
            <div id="status-jadwal" class="status-box">
                <span style="display: flex; align-items: center; gap: 10px;">
                    <svg class="spin" style="width:20px;height:20px" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/></svg> 
                    Menghubungkan ke Server...
                </span>
            </div>

            <input type="text" id="nim" class="login-input" placeholder="MASUKKAN NIM" maxlength="15">
            <button id="btn-login" class="btn-grad" onclick="login()" disabled>LOGIN SEKARANG</button>
            <p id="debug-msg" style="font-size:11px; color:rgba(255,255,255,0.6); margin-top:15px;">Pastikan koneksi internet stabil.</p>
        </div>
    </div>

    <div class="app-container animate-fade-in-up" style="display:none;" id="main-app">
        <div class="sidebar">
            <div class="header-top">
                <div class="student-info">
                    Peserta Ujian:
                    <strong id="mhs-name-display">-</strong>
                </div>
                <div class="timer-display" id="timer">00:00:00</div>
            </div>

            <div class="soal-container">
                <div class="soal-title">üìù Spesifikasi Soal: Aplikasi Kalkulator</div>
                <div class="soal-box">
                    <h4>Deskripsi Tugas</h4>
                    <p>Anda diminta mengembangkan aplikasi Flutter satu halaman (Single Page) yang berfungsi sebagai kalkulator penjumlahan sederhana antara dua angka.</p>
                    <br>
                    <h4>Kriteria Teknis Wajib (Rubrik Penilaian)</h4>
                    <ul>
                        <li>
                            <strong>Widget Input (Bobot 50%):</strong><br>
                             Gunakan 2 buah widget <code>TextField</code> untuk menerima input angka dari pengguna. Pastikan keduanya terhubung dengan <code>TextEditingController</code>.
                        </li>
                        <li>
                            <strong>Widget Kontrol (Bobot 25%):</strong><br>
                            Gunakan 1 buah widget tombol (contoh: <code>ElevatedButton</code>) untuk memicu perhitungan.
                        </li>
                        <li>
                            <strong>Logika & State (Bobot 25%):</strong><br>
                            Saat tombol ditekan, aplikasi harus melakukan parsing input string menjadi angka (<code>double.parse</code> atau <code>int.parse</code>), menjumlahkannya, dan memperbarui tampilan hasil menggunakan <code>setState()</code>.
                        </li>
                    </ul>
                    <p style="font-size: 0.9em; opacity: 0.8;"><em>Catatan: Gunakan DartPad di sebelah kanan untuk implementasi. UI harus muncul dan berfungsi.</em></p>
                </div>
            </div>

            <div class="submission-area">
                <p style="margin-bottom: 10px; font-weight: 600;">Pengumpulan Jawaban:</p>
                <textarea id="code" placeholder="// Salin SEMUA kode dari DartPad di kanan, lalu tempel di sini..."></textarea>
                <button class="btn-grad" onclick="submitExam()">KIRIM JAWABAN FINAL</button>
            </div>
        </div>
        <div class="main-panel">
            <iframe src="https://dartpad.dev/embed-flutter.html?theme=dark&run=true&split=55"></iframe>
        </div>
    </div>

<script>
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è PASTE URL APPS SCRIPT BARU BAPAK DI BAWAH INI ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxz96jPZ_y2wd3xapsHM_2x3UAanhX-9GjeEiX7NayXKwWbr1OIftGiCIaKGP7KqldB/exec"; 

    let studentName = "";
    let examEndTime = null;

    // --- CSS Spinner Animation ---
    const style = document.createElement('style');
    style.innerHTML = `.spin { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(style);

    // FUNGSI FETCH ROBUST
    async function kirimKeServer(dataPayload) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: "POST", body: JSON.stringify(dataPayload)
            });
            if (!response.ok) throw new Error("Server Error");
            return await response.json();
        } catch (error) {
            console.error(error);
            document.getElementById("debug-msg").innerText = "Error Koneksi. Coba refresh.";
            return null;
        }
    }

    // 1. ONLOAD: CEK JADWAL
    window.onload = async function() {
        if(SCRIPT_URL.includes("PASTE_URL")) return alert("URL Script belum disetting di HTML!");
        
        const data = await kirimKeServer({ action: "get_schedule" });
        if (data) checkTime(data);
        else document.getElementById("status-jadwal").innerHTML = "<span style='color:var(--danger)'>Gagal memuat jadwal. Refresh halaman.</span>";
    }

    // 2. CEK WAKTU
    function checkTime(jadwal) {
        const statusBox = document.getElementById("status-jadwal");
        const btn = document.getElementById("btn-login");
        const now = new Date();
        const start = new Date(jadwal.tanggal.replace(/-/g, "/") + " " + jadwal.jam_mulai);
        const end = new Date(jadwal.tanggal.replace(/-/g, "/") + " " + jadwal.jam_selesai);
        examEndTime = end;

        let infoStyle = "color: var(--text-light);";
        let statusBadge = "";

        if (now < start) {
            statusBadge = `<span style="color:var(--danger); font-weight:bold;">‚õî BELUM DIMULAI</span>`;
            btn.disabled = true; btn.innerText = "AKSES DITUTUP";
        } else if (now > end) {
            statusBadge = `<span style="color:var(--danger); font-weight:bold;">‚õî WAKTU HABIS</span>`;
            btn.disabled = true; btn.innerText = "AKSES DITUTUP";
        } else {
            statusBadge = `<span style="color:var(--success); font-weight:bold;">‚úÖ UJIAN BERLANGSUNG</span>`;
            btn.disabled = false;
        }

        statusBox.innerHTML = `
            <div style="${infoStyle} margin-bottom:5px;">üìÖ Tanggal: <strong>${jadwal.tanggal}</strong></div>
            <div style="${infoStyle} margin-bottom:10px;">‚è∞ Waktu: <strong>${jadwal.jam_mulai} - ${jadwal.jam_selesai}</strong></div>
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1)">Status: ${statusBadge}</div>
        `;
    }

    // 3. LOGIN
    async function login() {
        const nimInput = document.getElementById("nim");
        const nim = nimInput.value.trim();
        const btn = document.getElementById("btn-login");
        
        if(!nim) {
            nimInput.style.borderColor = "var(--danger)";
            setTimeout(() => nimInput.style.borderColor = "rgba(255,255,255,0.1)", 2000);
            return;
        }

        btn.innerHTML = '<svg class="spin" style="width:20px;height:20px;margin-right:10px" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/></svg> MEMERIKSA NIM...';
        btn.disabled = true;

        const data = await kirimKeServer({ action: "login", nim: nim });

        if (data && data.status == "ok") {
            studentName = data.nama;
            document.getElementById("mhs-name-display").innerText = studentName;
            
            // Transisi halus
            document.getElementById("overlay").style.opacity = '0';
            setTimeout(() => {
                document.getElementById("overlay").style.display = "none";
                document.getElementById("main-app").style.display = "flex";
            }, 500);
            
            runTimer();
        } else {
            alert(data ? "NIM Tidak Terdaftar!" : "Gagal Login.");
            btn.innerHTML = "LOGIN SEKARANG"; btn.disabled = false;
        }
    }

    // 4. TIMER
    function runTimer() {
        const timerDisplay = document.getElementById("timer");
        setInterval(() => {
            const now = new Date();
            const distance = examEndTime - now;
            if(distance < 0) {
                timerDisplay.innerText = "00:00:00";
                timerDisplay.style.color = "var(--danger)";
                alert("WAKTU HABIS! Jawaban dikirim otomatis.");
                submitExam(); return;
            }
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);
            timerDisplay.innerText = `${h}:${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
            
            // Efek 'Panic' jika waktu < 5 menit
            if(distance < 300000) timerDisplay.style.animation = "pulse 1s infinite";
        }, 1000);
    }

    // 5. SUBMIT
    async function submitExam() {
        const nim = document.getElementById("nim").value;
        const code = document.getElementById("code").value;
        
        if(code.length < 50 && confirm("Kode jawaban terlihat sangat pendek atau kosong. Yakin kirim?") == false) return;

        let score = 0;
        if(code.includes("TextField")) score += 25;
        if(code.includes("ElevatedButton")) score += 25;
        if(code.includes("setState")) score += 25;
        if(code.includes("parse") || code.includes("tryParse")) score += 25;

        const btn = document.querySelector(".submission-area button");
        btn.innerHTML = '<svg class="spin" style="width:20px;height:20px;margin-right:10px" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/></svg> MENGIRIM...';
        btn.disabled = true;

        const data = await kirimKeServer({ action: "submit", nama: studentName, nim: nim, nilai: score });
        
        if(data && data.result == "success") {
            document.body.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; background:var(--bg-dark); color:white; text-align:center;">
                    <h1 style="font-size:3em; margin-bottom:20px;">üéâ Ujian Selesai</h1>
                    <p style="font-size:1.2em; color:var(--text-gray);">Terima kasih, ${studentName}.<br>Jawaban Anda telah berhasil disimpan ke server.</p>
                </div>`;
        } else {
             btn.innerHTML = "KIRIM JAWABAN FINAL"; btn.disabled = false;
             alert("Gagal mengirim. Coba lagi.");
        }
    }
</script>
</body>
</html>